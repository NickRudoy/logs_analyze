# Анализатор прямого трафика Apache/Nginx логов

Скрипт `analyze_direct_traffic.py` анализирует access-логи Apache/Nginx (Combined Log Format), находит прямые заходы, считает отказы, выявляет подозрительные IP/User-Agent и формирует Excel-отчёт.

## Требования
- Python 3.9+
- Зависимости из `requirements.txt` (основные: `pandas`, `openpyxl`, опционально `requests` для GeoIP).

## Установка
```bash
python -m venv venv
source venv/bin/activate  # на Windows: venv\Scripts\activate
pip install -r requirements.txt
```

## Использование
```bash
python analyze_direct_traffic.py <путь_к_логу_или_директории> [опции]
```

### Примеры
- Один файл: `python analyze_direct_traffic.py logs/access.log`
- Все access-логи в каталоге: `python analyze_direct_traffic.py logs/`
- Явно указать домен: `python analyze_direct_traffic.py logs/ --domain example.com`
- С периодом: `python analyze_direct_traffic.py logs/ --start-date 2025-12-01 --end-date 2025-12-11`
- Если запускаете из корня проекта и укажете `/logs`, скрипт попробует найти `logs` рядом с собой или в текущем каталоге.

## Ключевые опции
- `log_path` (обязательный): файл access.log или директория с логами. В директории учитываются только файлы, где в имени есть `access`.
- `--domain`: домен сайта. По умолчанию `auto` — домен определяется из имён файлов и referer-ов в логах. Можно указать явно.
- `--start-date`, `--end-date`: фильтр по датам (формат `YYYY-MM-DD`). Конец дня выставляется в 23:59:59.
- `--no-geoip`: отключить запросы к GeoIP (быстрее, без данных о странах/датацентрах).

## Что делает скрипт
1) Парсит логи (один файл или все access-файлы в директории).  
   Поддерживаются Apache Combined и стандартный Nginx combined (`$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"`).  
2) Определяет домен (если не указан): сначала по именам логов, потом по referer-ам, иначе берёт дефолт.  
3) Выделяет прямой трафик (пустой/“-” referer или не содержит домен). Исключает ботов и статические ресурсы.  
4) Считает отказы: сессия IP+UA с ≤1 успешным (200) запросом.  
5) Ищет подозрительные паттерны: IP с множеством отказов, сканирование URL, частые запросы, датацентры, подозрительные User-Agent, паттерны ошибок.  
6) Формирует Excel-отчёт и печатает краткую сводку в консоль.

## Отчёт
- Имя файла: `<домен>_report_<YYYYMMDD_HHMMSS>.xlsx` (домен приводится к безопасному виду).  
- Листы: сводка, анализ по периодам, подозрительные IP, подозрительные User-Agent, статистика по странам, IP из датацентров, высокочастотные IP, паттерны ошибок, детали отказов (первые 1000).

## Типичные замечания
- Если нет `requests`, GeoIP отключится автоматически с предупреждением.  
- Если домен не удалось вывести из логов и не указан вручную, используется дефолт `example.com`.  
- Ошибка “путь не найден” — проверьте, что путь указан корректно; `/logs` будет интерпретирован как относительный к текущей или к каталогу скрипта.


